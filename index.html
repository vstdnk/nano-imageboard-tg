<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="/webapp-tg-imgboard/favicon.ico">
    <!-- Метатеги для iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TG Imgboard">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2678b6">
    <!-- Специфичные для iOS стили -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <link rel="apple-touch-icon" href="/webapp-tg-imgboard/apple-touch-icon.png">
    <link rel="manifest" href="/webapp-tg-imgboard/manifest.json">
    <title>TG Imgboard</title>

    <!-- Загружаем Telegram WebApp скрипт до основного приложения -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Встроенные базовые стили -->
    <style>
      :root {
        --tg-theme-bg-color: #ffffff;
        --tg-theme-text-color: #222222;
        --tg-theme-hint-color: #999999;
        --tg-theme-link-color: #2678b6;
        --tg-theme-button-color: #2678b6;
        --tg-theme-button-text-color: #ffffff;
        --tg-theme-secondary-bg-color: #f5f5f5;
        --safe-area-inset-top: env(safe-area-inset-top, 0px);
        --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      }
      
      html.dark {
        --tg-theme-bg-color: #212121;
        --tg-theme-text-color: #ffffff;
        --tg-theme-hint-color: #aaaaaa;
        --tg-theme-link-color: #8cc2ff;
        --tg-theme-button-color: #2678b6;
        --tg-theme-button-text-color: #ffffff;
        --tg-theme-secondary-bg-color: #292929;
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      html, body {
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
        /* Предотвращение прокрутки и полноэкранный режим */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
      }
      
      /* Специфичные стили для iOS в полноэкранном режиме */
      body.ios-fullscreen {
        /* Добавление полей под notch и home indicator */
        padding-top: var(--safe-area-inset-top);
        padding-bottom: var(--safe-area-inset-bottom);
        /* Фиксация размера экрана */
        height: 100vh;
        width: 100vw;
        /* Предотвращение скролла и эффектов scale */
        overflow: hidden;
        -webkit-overflow-scrolling: touch;
      }
      
      #app {
        height: 100%;
        width: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }
      
      #app-loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
        transition: opacity 0.3s;
        z-index: 9999;
      }
      
      #app-loading.hidden {
        opacity: 0;
        pointer-events: none;
        z-index: -1;
      }
      
      .spinner {
        width: 40px;
        height: 40px;
        margin-bottom: 20px;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--tg-theme-button-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      html.dark .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-left-color: var(--tg-theme-link-color);
      }
      
      .loading-text {
        font-size: 14px;
        letter-spacing: 1px;
        font-weight: bold;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Стили для базового интерфейса */
      .header {
        background-color: var(--tg-theme-secondary-bg-color);
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding-top: calc(16px + var(--safe-area-inset-top));
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }
      
      /* Специальные отступы для iOS в полноэкранном режиме */
      body.ios-fullscreen .header {
        padding-top: calc(16px + env(safe-area-inset-top, 20px));
      }
      
      .header h1 {
        font-size: 18px;
        font-weight: bold;
        flex-grow: 1;
        text-align: center;
      }
      
      .back-button {
        background: none;
        border: none;
        color: var(--tg-theme-button-color);
        font-size: 18px;
        padding: 8px;
        cursor: pointer;
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        display: flex;
        align-items: center;
        -webkit-appearance: none;
        appearance: none;
      }
      
      /* Полноэкранная кнопка */
      .fullscreen-button {
        background: none;
        border: none;
        color: var(--tg-theme-button-color);
        font-size: 18px;
        padding: 8px;
        cursor: pointer;
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        display: flex;
        align-items: center;
        -webkit-appearance: none;
        appearance: none;
      }
      
      /* Специфичные для iOS стили */
      @supports (-webkit-touch-callout: none) {
        .content {
          padding: 0;
          height: calc(100vh - 49px - env(safe-area-inset-top, 0px));
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          position: relative;
          z-index: 1;
        }
        
        /* Для iOS в полноэкранном режиме */
        body.ios-fullscreen .content {
          height: calc(100vh - 49px - env(safe-area-inset-top, 20px) - env(safe-area-inset-bottom, 20px));
        }
      }
      
      /* Стили для других платформ */
      @supports not (-webkit-touch-callout: none) {
        .content {
          padding: 0;
          height: calc(100% - 49px - var(--safe-area-inset-top));
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
      }
      
      .welcome-text {
        margin-bottom: 24px;
        font-size: 18px;
        text-align: center;
        padding: 20px 16px 0;
      }
      
      /* Стили для секций */
      .section {
        padding: 20px 16px;
        margin-bottom: 1px;
      }
      
      .section-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 12px;
        color: var(--tg-theme-text-color);
      }
      
      .section-content {
        background-color: var(--tg-theme-secondary-bg-color);
        border-radius: 12px;
        padding: 16px;
        min-height: 120px;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }
      
      .section-content p {
        color: var(--tg-theme-hint-color);
        font-size: 14px;
        line-height: 1.5;
      }
      
      /* Стили для списка досок */
      .boards-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .board-item {
        padding: 4px 0;
      }
      
      .board-link {
        color: var(--tg-theme-link-color);
        text-decoration: none;
        display: block;
        padding: 6px 0;
        font-size: 14px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }
      
      .board-name {
        font-weight: 500;
      }
      
      .loading-boards {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: var(--tg-theme-hint-color);
      }
      
      .error-message {
        padding: 20px;
        color: #ff3b30;
        text-align: center;
      }
      
      .cache-warning {
        padding: 10px;
        margin-bottom: 10px;
        background-color: rgba(255, 204, 0, 0.1);
        border-left: 3px solid #ffcc00;
        color: var(--tg-theme-hint-color);
        font-size: 13px;
        text-align: center;
        border-radius: 6px;
      }
      
      /* Дополнительные стили для темной темы */
      html.dark .board-link {
        border-bottom-color: rgba(255, 255, 255, 0.05);
      }
    </style>
    <script type="module" crossorigin src="/webapp-tg-imgboard/assets/index-BYsZT7GY.js"></script>
    <link rel="stylesheet" crossorigin href="/webapp-tg-imgboard/assets/index-7Wij1rAw.css">
  </head>
  <body>
    <!-- Базовый экран загрузки -->
    <div id="app-loading">
      <div class="spinner"></div>
      <div class="loading-text">BOARD LOADING...</div>
    </div>
    
    <!-- Базовый интерфейс приложения - будет виден даже без Vue -->
    <div id="basic-app" style="display: none; height: 100%; overflow: hidden;">
      <div class="header">
        <h1>TG Imgboard</h1>
        <button class="fullscreen-button" id="fullscreen-app">
          <span>⤢</span>
        </button>
      </div>
      
      <div class="content">
        <p class="welcome-text">
          Добро пожаловать в Telegram 2ch Imgboard!
        </p>
        
        <div id="boards-container">
          <!-- Здесь будут отображаться разделы и доски -->
          <div class="loading-boards">
            <div class="spinner"></div>
            <p>Загрузка списка досок...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Контейнер для Vue приложения -->
    <div id="app" style="display: none;"></div>

    <script>
      // Определяем iOS устройства
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      // Функция для загрузки списка досок с API 2ch.hk
      function loadBoards() {
        var boardsContainer = document.getElementById('boards-container');
        
        // Отображаем индикатор загрузки
        boardsContainer.innerHTML = '<div class="loading-boards"><div class="spinner"></div><p>Загрузка списка досок...</p></div>';
        
        // Проверяем кэш в localStorage
        var cachedData = localStorage.getItem('2ch_boards_data');
        var cachedTime = localStorage.getItem('2ch_boards_timestamp');
        var currentTime = new Date().getTime();
        
        // Если есть кэш и он не старше 1 часа, используем его
        if (cachedData && cachedTime && (currentTime - parseInt(cachedTime) < 3600000)) {
          try {
            var data = JSON.parse(cachedData);
            renderBoards(data);
            console.log('Данные загружены из кэша');
            return;
          } catch (e) {
            console.error('Ошибка при чтении кэша:', e);
            // Если ошибка при чтении кэша, продолжаем загрузку с сервера
          }
        }
        
        // Запрос к API с обработкой CORS
        var proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        var targetUrl = 'https://2ch.hk/api/mobile/v2/boards';
        
        fetch(targetUrl)
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Ошибка при загрузке данных: ' + response.status);
            }
            return response.json();
          })
          .then(function(data) {
            // Сохраняем данные в localStorage
            localStorage.setItem('2ch_boards_data', JSON.stringify(data));
            localStorage.setItem('2ch_boards_timestamp', currentTime.toString());
            
            renderBoards(data);
          })
          .catch(function(error) {
            console.error('Ошибка загрузки данных:', error);
            
            // Пробуем использовать прокси при ошибке CORS
            console.log('Пробуем использовать прокси...');
            fetch(proxyUrl + targetUrl)
              .then(function(response) {
                if (!response.ok) {
                  throw new Error('Ошибка при загрузке данных через прокси: ' + response.status);
                }
                return response.json();
              })
              .then(function(data) {
                // Сохраняем данные в localStorage
                localStorage.setItem('2ch_boards_data', JSON.stringify(data));
                localStorage.setItem('2ch_boards_timestamp', currentTime.toString());
                
                renderBoards(data);
              })
              .catch(function(error) {
                console.error('Ошибка загрузки данных через прокси:', error);
                
                // Если есть устаревший кэш, используем его как запасной вариант
                if (cachedData) {
                  try {
                    var oldData = JSON.parse(cachedData);
                    renderBoards(oldData);
                    console.log('Данные загружены из устаревшего кэша');
                    
                    // Показываем предупреждение о устаревших данных
                    var warning = document.createElement('div');
                    warning.className = 'cache-warning';
                    warning.textContent = 'Отображены сохраненные данные. Не удалось обновить информацию.';
                    boardsContainer.insertBefore(warning, boardsContainer.firstChild);
                    
                    return;
                  } catch (e) {
                    console.error('Ошибка при чтении устаревшего кэша:', e);
                  }
                }
                
                boardsContainer.innerHTML = '<div class="error-message"><p>Ошибка при загрузке списка досок. Пожалуйста, попробуйте позже.</p></div>';
              });
          });
      }
      
      // Функция для отображения досок
      function renderBoards(data) {
        var boardsContainer = document.getElementById('boards-container');
        
        // Группируем доски по категориям
        var categories = {};
        
        // Перебираем все доски и группируем их по категориям
        data.data.forEach(function(board) {
          if (!categories[board.category]) {
            categories[board.category] = [];
          }
          categories[board.category].push(board);
        });
        
        // Очищаем контейнер
        boardsContainer.innerHTML = '';
        
        // Создаем секции для каждой категории
        Object.keys(categories).sort().forEach(function(categoryName) {
          var section = document.createElement('div');
          section.className = 'section';
          
          var sectionTitle = document.createElement('div');
          sectionTitle.className = 'section-title';
          sectionTitle.textContent = categoryName;
          
          var sectionContent = document.createElement('div');
          sectionContent.className = 'section-content';
          
          // Создаем список досок для этой категории
          var boardsList = document.createElement('div');
          boardsList.className = 'boards-list';
          
          // Сортируем доски по ID
          categories[categoryName].sort(function(a, b) {
            return a.id.localeCompare(b.id);
          }).forEach(function(board) {
            var boardItem = document.createElement('div');
            boardItem.className = 'board-item';
            
            var boardLink = document.createElement('a');
            boardLink.href = 'javascript:void(0);';
            boardLink.className = 'board-link';
            boardLink.setAttribute('data-board', board.id);
            
            var boardName = document.createElement('span');
            boardName.className = 'board-name';
            boardName.textContent = '/' + board.id + '/ - ' + board.name;
            
            boardLink.appendChild(boardName);
            boardItem.appendChild(boardLink);
            boardsList.appendChild(boardItem);
            
            // Добавляем обработчик клика
            boardLink.addEventListener('click', function() {
              alert('Выбрана доска: /' + board.id + '/ - ' + board.name);
              // Здесь можно добавить переход на доску
            });
          });
          
          sectionContent.appendChild(boardsList);
          section.appendChild(sectionTitle);
          section.appendChild(sectionContent);
          
          boardsContainer.appendChild(section);
        });
      }
      
      // Базовая проверка наличия Telegram WebApp API
      window.addEventListener('DOMContentLoaded', function() {
        // Элементы страницы
        var appLoading = document.getElementById('app-loading');
        var basicApp = document.getElementById('basic-app');
        var vueApp = document.getElementById('app');
        var isAppHidden = false;
        
        // Загружаем список досок
        loadBoards();
        
        // Настраиваем для iOS
        if (isIOS) {
          document.body.classList.add('ios');
          
          // Специальные настройки для iOS полноэкранного режима
          // Предотвращаем скроллинг страницы целиком на iOS
          document.addEventListener('touchmove', function(event) {
            // Разрешаем скроллинг только внутри элементов с классом content
            if (!event.target.closest('.content')) {
              event.preventDefault();
            }
          }, { passive: false });
        }
        
        // Инициализация Telegram API
        var tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
          tg = window.Telegram.WebApp;
          
          // Отключаем свайп вниз для закрытия приложения
          try {
            if (window.Telegram && window.Telegram.WebApp) {
              var eventData = JSON.stringify({ allow_vertical_swipe: false });
              if (window.TelegramWebviewProxy) {
                window.TelegramWebviewProxy.postEvent('web_app_setup_swipe_behavior', eventData);
              } else {
                window.parent.postMessage(JSON.stringify({
                  eventType: 'web_app_setup_swipe_behavior',
                  eventData: { allow_vertical_swipe: false }
                }), 'https://web.telegram.org');
              }
              console.log('Свайп вниз отключен');
            }
          } catch (e) {
            console.error('Ошибка при отключении свайпа вниз:', e);
          }
          
          // Блокировка ориентации экрана в портретном режиме
          try {
            if (window.Telegram && window.Telegram.WebApp) {
              var orientationData = JSON.stringify({ locked: true });
              if (window.TelegramWebviewProxy) {
                window.TelegramWebviewProxy.postEvent('web_app_toggle_orientation_lock', orientationData);
              } else {
                window.parent.postMessage(JSON.stringify({
                  eventType: 'web_app_toggle_orientation_lock',
                  eventData: { locked: true }
                }), 'https://web.telegram.org');
              }
              console.log('Ориентация экрана заблокирована');
            }
          } catch (e) {
            console.error('Ошибка при блокировке ориентации экрана:', e);
          }
          
          // Применяем темную тему если нужно
          if (tg.colorScheme === 'dark') {
            document.documentElement.classList.add('dark');
          }
          
          // Настройка переменных CSS на основе Telegram темы
          if (tg.themeParams) {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color);
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
          }
          
          // Кнопка закрытия удалена
          
          // Обработчик для кнопки полного экрана
          var fullscreenButton = document.getElementById('fullscreen-app');
          if (fullscreenButton) {
            // Функция переключения полноэкранного режима
            var toggleFullScreen = function() {
              try {
                if (isIOS) {
                  // Специальный подход для iOS
                  document.body.classList.toggle('ios-fullscreen');
                  
                  // Используем несколько методов для полноэкранного режима на iOS
                  if (tg.isExpanded) {
                    // Если метод requestFullscreen доступен
                    if (typeof tg.requestFullscreen === 'function') {
                      tg.requestFullscreen();
                    }
                  }
                  
                  // В любом случае используем expand для iOS
                  if (typeof tg.expand === 'function') {
                    tg.expand();
                  }
                  
                  // Дополнительно для iOS устанавливаем специфичные стили
                  setTimeout(function() {
                    // Устанавливаем viewport на полный размер
                    var viewportMeta = document.querySelector('meta[name="viewport"]');
                    if (viewportMeta) {
                      viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui');
                    }
                    
                    // Обновляем скролл в контентной области
                    var content = document.querySelector('.content');
                    if (content) {
                      content.style.overflow = 'hidden';
                      setTimeout(function() {
                        content.style.overflow = 'auto';
                      }, 50);
                    }
                  }, 100);
                } else {
                  // Для других платформ используем стандартный подход
                  if (tg && typeof tg.requestFullscreen === 'function') {
                    tg.requestFullscreen();
                  } else if (tg && typeof tg.expand === 'function') {
                    // Если requestFullscreen не доступен, используем expand как запасной вариант
                    tg.expand();
                  }
                }
              } catch (e) {
                console.error('Ошибка при переключении полноэкранного режима:', e);
              }
            };
            
            // Добавляем обработчики событий
            fullscreenButton.addEventListener('click', toggleFullScreen);
            
            if (isIOS) {
              fullscreenButton.addEventListener('touchstart', function() {
                this.style.opacity = '0.7';
              });
              fullscreenButton.addEventListener('touchend', function() {
                this.style.opacity = '1';
                toggleFullScreen();
              });
            }
          }
          
          // Попытка включить полноэкранный режим сразу при загрузке
          setTimeout(function() {
            try {
              // Вызываем функцию переключения полноэкранного режима
              toggleFullScreen();
              console.log('Автоматически активирован полноэкранный режим');
            } catch (e) {
              console.error('Ошибка при активации полноэкранного режима:', e);
            }
          }, isIOS ? 1000 : 500);
        }
        
        // Функция скрытия экрана загрузки
        window.hideLoading = function() {
          if (isAppHidden) return; // Предотвращаем повторное скрытие
          isAppHidden = true;
          
          // Скрываем экран загрузки
          appLoading.classList.add('hidden');
          
          // Показываем базовый интерфейс
          basicApp.style.display = 'block';
          
          try {
            // Пытаемся монтировать Vue приложение с задержкой
            setTimeout(function() {
              vueApp.style.display = 'block';
              
              // iOS-специфичная подстройка скролла
              if (isIOS) {
                // Иногда для iOS требуется принудительно обновить область прокрутки
                var content = document.querySelector('.content');
                if (content) {
                  content.style.overflow = 'hidden';
                  setTimeout(function() {
                    content.style.overflow = 'auto';
                  }, 50);
                }
              }
              
              // Полностью удаляем экран загрузки после анимации
              setTimeout(function() {
                if (appLoading.parentNode) {
                  appLoading.parentNode.removeChild(appLoading);
                }
              }, 300);
            }, 100);
          } catch (e) {
            console.error('Ошибка при инициализации Vue:', e);
          }
        };
        
        // Инициализация Telegram WebApp и автоматическое скрытие экрана загрузки
        setTimeout(function() {
          if (window.Telegram && window.Telegram.WebApp) {
            try {
              // Сообщаем Telegram что приложение готово
              window.Telegram.WebApp.ready();
              window.Telegram.WebApp.expand();
              
              // Принудительно устанавливаем полноэкранный режим
              document.documentElement.style.height = '100%';
              document.body.style.height = '100%';
            } catch (e) {
              console.error('Ошибка при инициализации Telegram WebApp:', e);
            }
          }
          
          // ВАЖНО: Принудительно скрываем экран загрузки через 1 секунду
          // Для iOS делаем немного дольше
          setTimeout(function() {
            window.hideLoading();
          }, isIOS ? 1000 : 500);
        }, 100);
        
        // Дополнительная защита: скрываем экран загрузки при загрузке страницы
        window.addEventListener('load', function() {
          setTimeout(function() {
            window.hideLoading();
          }, 500);
        });
      });
    </script>
    
    <!-- Vue приложение (загружается отложенно) -->
  </body>
</html>
