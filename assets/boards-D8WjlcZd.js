var l=(h,t,e)=>new Promise((o,s)=>{var a=n=>{try{c(e.next(n))}catch(p){s(p)}},i=n=>{try{c(e.throw(n))}catch(p){s(p)}},c=n=>n.done?o(n.value):Promise.resolve(n.value).then(a,i);c((e=e.apply(h,t)).next())});const r="https://2ch.hk",u=["https://corsproxy.io/?","https://api.allorigins.win/raw?url=","https://cors-anywhere.herokuapp.com/","https://thingproxy.freeboard.io/fetch/","https://api.codetabs.com/v1/proxy?quest="];class g{static getBoards(){return l(this,null,function*(){console.log("Загрузка списка досок...");for(const t of u)try{const e=t==="https://api.allorigins.win/raw?url="?`${t}${encodeURIComponent(`${r}/api/boards.json`)}`:`${t}${encodeURIComponent(`${r}/api/boards.json`)}`;console.log(`Пробуем прокси: ${t}`);const o=yield fetch(e,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},timeout:1e4});if(o.ok){const s=yield o.json();return console.log("Данные досок успешно загружены"),this.processBoardsData(s)}else console.warn(`Прокси ${t} вернул статус: ${o.status}`)}catch(e){console.warn(`CORS proxy ${t} failed:`,e.message);continue}return console.warn("All CORS proxies failed, using fallback data"),this.getFallbackBoards()})}static getFallbackBoards(){return[{id:"b",name:"Бред",category:"Тематика",description:"Доска для обсуждения всего подряд"},{id:"o",name:"Общение",category:"Тематика",description:"Доска для общения"},{id:"soc",name:"Общество",category:"Тематика",description:"Общественные темы"},{id:"media",name:"Медиа",category:"Медиа",description:"Медиа контент"},{id:"a",name:"Аниме",category:"Японская культура",description:"Аниме и манга"},{id:"v",name:"Видеоигры",category:"Развлечения",description:"Видеоигры"},{id:"p",name:"Фото",category:"Творчество",description:"Фотографии"},{id:"s",name:"Программирование",category:"Технологии",description:"Программирование"}]}static processBoardsData(t){const e=[];return t.boards&&Object.keys(t.boards).forEach(o=>{const s=t.boards[o];e.push({id:o,name:s.name||o,category:this.mapCategory(s.category||"Разное"),description:s.description||"",bump_limit:s.bump_limit||500,pages:s.pages||10})}),t.additional_boards&&Object.keys(t.additional_boards).forEach(o=>{const s=t.additional_boards[o];e.push({id:o,name:s.name||o,category:this.mapCategory(s.category||"Разное"),description:s.description||"",bump_limit:s.bump_limit||500,pages:s.pages||10})}),e}static getThreads(t,e=1){return l(this,null,function*(){console.log(`Загрузка тредов для доски ${t}, страница ${e}...`);for(const o of u)try{const s=o==="https://api.allorigins.win/raw?url="?`${o}${encodeURIComponent(`${r}/${t}/${e}.json`)}`:`${o}${encodeURIComponent(`${r}/${t}/${e}.json`)}`;console.log(`Пробуем прокси для тредов: ${o}`);const a=yield fetch(s,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},timeout:15e3});if(a.ok){const i=yield a.json();return console.log(`Треды для доски ${t} успешно загружены`),this.processThreadsData(i,t,e)}else console.warn(`Прокси ${o} вернул статус для тредов: ${a.status}`)}catch(s){console.warn(`CORS proxy ${o} failed for threads:`,s.message);continue}return console.warn("All CORS proxies failed for threads, using fallback data"),this.getFallbackThreads(t,e)})}static getFallbackThreads(t,e){return{threads:[{id:1,title:"Тестовый тред 1",thumbnail:"https://via.placeholder.com/300x200",image_url:"https://via.placeholder.com/800x600",created_at:Date.now()/1e3,posts_count:5,files_count:2,views:100,score:0},{id:2,title:"Тестовый тред 2",thumbnail:"https://via.placeholder.com/300x200",image_url:"https://via.placeholder.com/800x600",created_at:Date.now()/1e3,posts_count:3,files_count:1,views:50,score:0},{id:3,title:"Тестовый тред 3",thumbnail:"https://via.placeholder.com/300x200",image_url:"https://via.placeholder.com/800x600",created_at:Date.now()/1e3,posts_count:8,files_count:3,views:200,score:0}],page:e,pages:1}}static processThreadsData(t,e,o){const s=[];return t.threads&&t.threads.forEach(a=>{let i=null;if(a.posts&&a.posts.length>0){const n=a.posts[0];n.files&&n.files.length>0&&(i=n.files[0])}let c="Без названия";if(a.posts&&a.posts[0]){const n=a.posts[0];n.subject?c=n.subject:n.comment&&(c=n.comment.replace(/<[^>]*>/g,"").substring(0,100),c.length===100&&(c+="..."))}s.push({id:a.num,title:c,thumbnail:i?this.getThumbnailUrl(e,i.name):null,image_url:i?this.getImageUrl(e,i.name):null,created_at:a.date,posts_count:a.posts_count||0,files_count:a.files_count||0,views:a.views||0,score:a.score||0})}),console.log(`Обработано ${s.length} тредов для доски ${e}`),{threads:s,page:o,pages:t.pages||1}}static getThread(t,e){return l(this,null,function*(){console.log(`Загрузка треда ${e} с доски ${t}...`);for(const o of u)try{const s=o==="https://api.allorigins.win/raw?url="?`${o}${encodeURIComponent(`${r}/${t}/res/${e}.json`)}`:`${o}${encodeURIComponent(`${r}/${t}/res/${e}.json`)}`;console.log(`Пробуем прокси для треда: ${o}`);const a=yield fetch(s,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},timeout:2e4});if(a.ok){const i=yield a.json();return console.log(`Тред ${e} успешно загружен`),i}else console.warn(`Прокси ${o} вернул статус для треда: ${a.status}`)}catch(s){console.warn(`CORS proxy ${o} failed for thread:`,s.message);continue}throw new Error("All CORS proxies failed for thread")})}static mapCategory(t){return{Разное:"Разное",Тематика:"Тематика","Японская культура":"Японская культура",Технологии:"Технологии",Творчество:"Творчество",Развлечения:"Развлечения",Медиа:"Медиа",Политика:"Политика","Взрослый контент":"Взрослый контент",Other:"Разное",Thematic:"Тематика","Japanese Culture":"Японская культура",Technology:"Технологии",Creative:"Творчество",Entertainment:"Развлечения",Media:"Медиа",Politics:"Политика","Adult Content":"Взрослый контент"}[t]||"Разное"}static getImageUrl(t,e){return`${r}/${t}/${e}`}static getThumbnailUrl(t,e){const o=e.replace(/\.[^/.]+$/,""),s=e.split(".").pop();return`${r}/${t}/thumb/${o}_thumb.${s}`}}export{g as BoardsAPI};
